<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vera Chat - Enhanced</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.2/standalone/umd/vis-network.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .header {
            background: #1e293b;
            padding: 12px 20px;
            border-bottom: 2px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #vera-robot {
            width: 80px;
            height: 80px;
        }
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .chat-panel, .graph-panel {
            display: flex;
            flex-direction: column;
            background: #1e293b;
            position: relative;
            transition: all 0.3s ease;
        }

        .chat-panel {
            width: 50%;
            border-right: 2px solid #334155;
        }

        .graph-panel {
            width: 50%;
        }

        .chat-panel.fullscreen, .graph-panel.fullscreen {
            width: 100% !important;
            z-index: 100;
        }

        .chat-panel.fullscreen ~ .graph-panel {
            display: none;
        }

        .graph-panel.fullscreen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

        .fullscreen ~ .chat-panel {
            display: none;
        }

        .fullscreen ~ .resizer {
            display: none;
        }

        .resizer {
            width: 6px;
            background: #334155;
            cursor: col-resize;
            position: absolute;
            top: 0;
            bottom: 0;
            left: 50%; /* Ensure it starts in the correct position */
            z-index: 10;
            transition: background 0.2s, left 0.3s ease; /* Add smooth transition for position */
        }

        .resizer:hover {
            background: #475569;
        }

        .resizer.resizing {
            background: #3b82f6;
        }

        .panel-header {
            padding: 12px 16px;
            background: #0f172a;
            border-bottom: 1px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            font-weight: 600;
            font-size: 14px;
            color: #94a3b8;
        }

        .panel-controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .panel-btn {
            background: #1e293b;
            border: 1px solid #334155;
            color: #cbd5e1;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .panel-btn:hover {
            background: #334155;
            border-color: #475569;
        }

        .tab-nav {
            display: flex;
            gap: 4px;
            padding: 8px 16px 0 16px;
            background: #0f172a;
            border-bottom: 1px solid #334155;
        }

        .tab-btn {
            background: transparent;
            border: none;
            color: #94a3b8;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            border-radius: 6px 6px 0 0;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
        }

        .tab-btn:hover {
            background: rgba(59, 130, 246, 0.1);
            color: #cbd5e1;
        }

        .tab-btn.active {
            background: #1e293b;
            color: #60a5fa;
            border-bottom: 2px solid #60a5fa;
        }

        .tab-content {
            display: none;
            flex: 1;
            position: relative;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
        }

        #chatMessages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message {
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #3b82f6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 12px;
            flex-shrink: 0;
        }

        .message.assistant .message-avatar {
            background: #8b5cf6;
        }

        .message.system .message-avatar {
            background: #10b981;
        }

        .message-content {
            background: #0f172a;
            padding: 12px 16px;
            border-radius: 8px;
            max-width: 70%;
            line-height: 1.6;
            font-size: 14px;
            position: relative;
        }

        .message.user .message-content {
            background: #1e3a8a;
        }

        .message-copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(51, 65, 85, 0.8);
            border: none;
            color: #cbd5e1;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.2s, background 0.2s;
        }

        .message-content:hover .message-copy-btn {
            opacity: 1;
        }

        .message-copy-btn:hover {
            background: rgba(51, 65, 85, 1);
        }

        .input-area {
            padding: 16px;
            background: #0f172a;
            border-top: 1px solid #334155;
        }

        .input-wrapper {
            display: flex;
            gap: 8px;
        }

        #messageInput {
            flex: 1;
            background: #1e293b;
            border: 1px solid #334155;
            color: #e2e8f0;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            resize: none;
            font-family: inherit;
        }

        #messageInput:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .send-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }

        .send-btn:hover {
            background: #2563eb;
        }

        .send-btn:disabled {
            background: #334155;
            cursor: not-allowed;
        }

        #graph {
            position: absolute;
            top: 48px;
            left: 0;
            right: 0;
            bottom: 0;
            background: #0f172a;
        }

        .graph-stats {
            position: absolute;
            top: 60px;
            right: 16px;
            background: rgba(15, 23, 42, 0.9);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            border: 1px solid #334155;
            z-index: 5;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }

        .status-indicator.connected {
            background: #10b981;
        }

        .status-indicator.disconnected {
            background: #ef4444;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0f172a;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }

        #settings-panel {
            position: fixed;
            top: 0;
            left: -320px;
            width: 320px;
            height: 100vh;
            background: #1e293b;
            border-right: 2px solid #334155;
            overflow-y: auto;
            transition: left 0.3s ease;
            z-index: 1000;
            padding: 16px;
        }

        #settings-toggle-btn {
            position: fixed;
            bottom: 100px;
            left: 0;
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 8px;
            cursor: pointer;
            z-index: 9999;
            border-radius: 0 6px 6px 0;
            font-size: 16px;
            transition: background 0.2s;
        }

        #settings-toggle-btn:hover {
            background: #2563eb;
        }

        .settings-section {
            margin-bottom: 24px;
        }

        .settings-section h3 {
            font-size: 14px;
            color: #60a5fa;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .filter-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .filter-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .filter-item label {
            font-size: 13px;
            color: #cbd5e1;
            cursor: pointer;
            flex: 1;
        }

        .settings-btn {
            background: #1e293b;
            border: 1px solid #334155;
            color: #cbd5e1;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 8px;
            margin-bottom: 8px;
            transition: all 0.2s;
        }

        .settings-btn:hover {
            background: #334155;
            border-color: #475569;
        }

        .slider-container {
            margin-bottom: 16px;
        }

        .slider-container label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
            color: #cbd5e1;
        }

        .slider-container input[type="range"] {
            width: 100%;
            cursor: pointer;
        }

        .slider-container select {
            width: 100%;
            padding: 8px;
            background: #0f172a;
            border: 1px solid #334155;
            color: #e2e8f0;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
        }

        #property-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: #1e293b;
            border-left: 2px solid #334155;
            overflow-y: auto;
            transition: right 0.3s ease;
            z-index: 10001;
            display: flex;
            flex-direction: column;
        }

        #property-panel.active {
            right: 0;
        }

        .panel-header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: #0f172a;
            border-bottom: 1px solid #334155;
        }

        .panel-header-controls h2 {
            font-size: 16px;
            color: #60a5fa;
            margin: 0;
        }

        #panel-content {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
        }

        .section {
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 12px;
            color: #60a5fa;
            text-transform: uppercase;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .property {
            background: #0f172a;
            padding: 8px 12px;
            border-radius: 4px;
            margin-bottom: 8px;
            font-size: 13px;
            color: #cbd5e1;
            word-wrap: break-word;
        }

        .property-key {
            color: #60a5fa;
            font-weight: 600;
        }

        .label-badge {
            display: inline-block;
            background: #3b82f6;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            margin: 2px;
        }

        .neighbor-item {
            background: #0f172a;
            padding: 10px 12px;
            border-radius: 4px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid #3b82f6;
        }

        .neighbor-item:hover {
            background: #1e293b;
            transform: translateX(4px);
        }

        .neighbor-name {
            font-size: 13px;
            color: #e2e8f0;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .neighbor-relationship {
            font-size: 11px;
            color: #94a3b8;
        }

        .vector-item {
            background: #0f172a;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 8px;
            border-left: 3px solid #8b5cf6;
        }

        .vector-type {
            font-size: 11px;
            color: #a78bfa;
            margin-bottom: 6px;
            font-weight: 600;
        }

        #context-menu {
            position: fixed;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 6px;
            padding: 4px 0;
            min-width: 200px;
            display: none;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .context-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            color: #cbd5e1;
            font-size: 13px;
            transition: background 0.2s;
        }

        .context-menu-item:hover {
            background: #334155;
        }

        #search-container {
            position: absolute;
            top: 60px;
            left: 16px;
            z-index: 5;
            max-width: 400px;
        }

        #search-input {
            width: 300px;
            padding: 10px 12px;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid #334155;
            color: #e2e8f0;
            border-radius: 6px;
            font-size: 13px;
        }

        #search-input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        #search-btn {
            margin-left: 8px;
            padding: 10px 16px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
        }

        #search-btn:hover {
            background: #2563eb;
        }

        #search-results {
            margin-top: 8px;
            background: rgba(15, 23, 42, 0.98);
            border: 1px solid #334155;
            border-radius: 6px;
            max-height: 400px;
            overflow-y: auto;
            display: none;
        }

        .search-result-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #334155;
            transition: background 0.2s;
        }

        .search-result-item:hover {
            background: #1e293b;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-name {
            font-size: 13px;
            color: #e2e8f0;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .search-result-labels {
            font-size: 11px;
            color: #94a3b8;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1 style="font-size: 20px; margin-bottom: 4px;">Vera Chat</h1>
                <div style="font-size: 12px; color: #94a3b8;">
                    <span id="connectionStatus">Connecting...</span> ‚Ä¢ 
                    <span id="sessionInfo">No session</span>
                </div>
            </div>

        <div id="vera-robot"></div>
        </div>

        <div class="main-content">
            <div class="chat-panel" id="chatPanel">
                <div class="panel-header">
                    <span class="panel-title">CHAT</span>
                    <div class="panel-controls">
                        <button class="panel-btn" onclick="app.clearChat()">üóëÔ∏è Clear</button>
                        <button class="panel-btn" onclick="app.exportChat()">üíæ Export</button>
                        <button class="panel-btn" onclick="app.toggleFullscreen('chat')" id="chatFullscreenBtn">‚õ∂ Fullscreen</button>
                    </div>
                </div>

                <div id="chatMessages"></div>

                <div class="input-area">
                    <div class="input-wrapper">
                        <textarea id="messageInput" placeholder="Type your message..." rows="1"></textarea>
                        <button class="send-btn" id="sendBtn" onclick="app.sendMessage()">Send</button>
                    </div>
                </div>
            </div>

            <div class="resizer" id="resizer"></div>

            <div class="graph-panel" id="graphPanel">
                <div class="tab-nav">
                    <button class="tab-btn " onclick="app.switchTab('notebook')">üìì Notebook</button>
                    <button class="tab-btn active" onclick="app.switchTab('graph')">üìä Knowledge Graph</button>
                    <button class="tab-btn " onclick="app.switchTab('memory')">üìÑ Memory</button>
                    <button class="tab-btn " onclick="app.switchTab('vector')">üìÑ Vector Store</button>
                    <button class="tab-btn" onclick="app.switchTab('toolchain')">üîß Toolchain</button>
                    <button class="tab-btn" onclick="app.switchTab('orchestration')">üéª Orchestration</button>
                    <button class="tab-btn" onclick="app.switchTab('analytics')">üìà Analytics</button>
                    <button class="tab-btn" onclick="app.switchTab('files')">üìÅ Files</button>
                    <button class="tab-btn" onclick="app.switchTab('settings')">‚öôÔ∏è Settings</button>
                </div>

                <div class="tab-content active" id="tab-graph" style="position: relative;">
                    <div class="panel-header">
                        <span class="panel-title">KNOWLEDGE GRAPH</span>
                        <div class="panel-controls">
                            <button class="panel-btn" onclick="app.testPanel()">üß™ Test Panel</button>
                            <button class="panel-btn" onclick="app.testPanel()">‚û∞ Cluster Hubs</button>
                            <button class="panel-btn" onclick="app.fitGraph()">üéØ Fit</button>
                            <button class="panel-btn" onclick="app.zoomIn()">üîç+</button>
                            <button class="panel-btn" onclick="app.zoomOut()">üîç-</button>
                            <button class="panel-btn" onclick="app.loadGraph()">üîÑ Refresh</button>
                            <button class="panel-btn" onclick="app.toggleFullscreen('graph')" id="graphFullscreenBtn">‚õ∂</button>
                        </div>
                    </div>

                    <div id="graph"></div>

                    <div class="graph-stats">
                        <div>Nodes: <span id="nodeCount">0</span></div>
                        <div>Edges: <span id="edgeCount">0</span></div>
                    </div>

                    <button id="settings-toggle-btn" onclick="window.GraphAddon && window.GraphAddon.toggleSettings()">‚öôÔ∏è</button>

                    <div id="search-container">
                        <input type="text" id="search-input" placeholder="Search nodes...">
                        <button id="search-btn">Search</button>
                        <div id="search-results"></div>
                    </div>
                </div>
                <div class="tab-content" id="tab-memory" style="padding: 20px; overflow-y: auto;">
                    <h2 style="color: #60a5fa; margin-bottom: 16px;">Memory</h2>
                    <div id="memory-content">
                        <p style="color: #94a3b8;">Loading memory system...</p>
                    </div>
                </div>
                <div class="tab-content" id="tab-notebook" style="padding: 20px; overflow-y: auto;">
                    <h2 style="color: #60a5fa; margin-bottom: 16px;">Analytics</h2>
                    <p style="color: #94a3b8;">Notebook dashboard coming soon...</p>
                </div>
                <div class="tab-content" id="tab-orchestration" style="padding: 20px; overflow-y: auto;">
                    <h2 style="color: #60a5fa; margin-bottom: 16px;">Analytics</h2>
                    <p style="color: #94a3b8;">Orchestration dashboard coming soon...</p>
                </div>

                <div class="tab-content" id="tab-toolchain" style="padding: 20px; overflow-y: auto;">
                    <h2 style="color: #60a5fa; margin-bottom: 16px;">Analytics</h2>
                    <p style="color: #94a3b8;">Toolchain dashboard coming soon...</p>
                </div>

                <div class="tab-content" id="tab-analytics" style="padding: 20px; overflow-y: auto;">
                    <h2 style="color: #60a5fa; margin-bottom: 16px;">Analytics</h2>
                    <p style="color: #94a3b8;">Analytics dashboard coming soon...</p>
                </div>

                <div class="tab-content" id="tab-files" style="padding: 20px; overflow-y: auto;">
                    <h2 style="color: #60a5fa; margin-bottom: 16px;">Files</h2>
                    <p style="color: #94a3b8;">File management coming soon...</p>
                </div>

                <div class="tab-content" id="tab-settings" style="padding: 20px; overflow-y: auto;">
                    <h2 style="color: #60a5fa; margin-bottom: 16px;">Settings</h2>
                    <p style="color: #94a3b8;">Application settings coming soon...</p>
                </div>
            </div>
        </div>

        <div id="settings-panel">
            <div class="settings-section">
                <h3>Graph Controls</h3>
                <button class="settings-btn" id="reset-focus-btn">Reset View</button>
                <button class="settings-btn" id="cluster-hubs-btn">Cluster Hubs</button>
            </div>

            <div class="settings-section">
                <h3>Edge Filters</h3>
                <div style="margin-bottom: 12px;">
                    <button class="settings-btn" id="select-all-filters-btn">Select All</button>
                    <button class="settings-btn" id="deselect-all-filters-btn">Deselect All</button>
                    <button class="settings-btn" id="refresh-filters-btn">Refresh</button>
                </div>
                <div>
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px; font-size: 13px; color: #cbd5e1;">
                        <input type="checkbox" id="cascade-hide">
                        Hide isolated nodes
                    </label>
                </div>
                <div id="edge-filters"></div>
            </div>

            <div class="settings-section">
                <h3>Visual Settings</h3>
                
                <div class="slider-container">
                    <label>
                        <span>Node Style</span>
                    </label>
                    <select id="nodeStyle">
                        <option value="dot">Dot</option>
                        <option value="box">Box</option>
                        <option value="card">Card View</option>
                        <option value="circle">Circle</option>
                        <option value="ellipse">Ellipse</option>
                        <option value="diamond">Diamond</option>
                    </select>
                </div>

                <div class="slider-container">
                    <label>
                        <span>Node Size</span>
                        <span id="nodeSizeVal">25</span>
                    </label>
                    <input type="range" id="nodeSize" min="10" max="50" value="25">
                </div>

                <div class="slider-container">
                    <label>
                        <span>Edge Width</span>
                        <span id="edgeWidthVal">2</span>
                    </label>
                    <input type="range" id="edgeWidth" min="1" max="10" value="2">
                </div>

                <div class="slider-container">
                    <label>
                        <span>Physics Strength</span>
                        <span id="physicsVal">0.010</span>
                    </label>
                    <input type="range" id="physics" min="0.001" max="0.1" step="0.001" value="0.01">
                </div>
            </div>
        </div>

        <div id="property-panel">
            <div class="panel-header-controls">
                <h2>Node Details</h2>
                <button class="panel-btn" id="close-panel-btn" onclick="document.getElementById('property-panel').classList.remove('active');">‚úï</button>
            </div>
            <div id="panel-content">
                <p style="color: #94a3b8; padding: 20px;">Click a node to see details...</p>
            </div>
        </div>

        <div id="context-menu">
            <div class="context-menu-item" data-action="search">üîç Search</div>
            <div class="context-menu-item" data-action="enrich">üß† Enrich (NLP)</div>
            <div class="context-menu-item" data-action="hidden-relationships">üîó Hidden Relationships</div>
            <div class="context-menu-item" data-action="discover">üí° Discover</div>
            <div class="context-menu-item" data-action="ideas">‚ú® Generate Ideas</div>
            <div class="context-menu-item" data-action="subgraph">üó∫Ô∏è Extract Subgraph</div>
            <div class="context-menu-item" data-action="ask-vera">üí¨ Ask Vera</div>
            <div class="context-menu-item" data-action="extract-entities">üß† Extract Entities</div>
        </div>
    </div>

    <script src="graph-addon.js"></script>
    <script src="tamagochi/tamagochi_robot.js"></script> 
    <script>
        class VeraChat {
            constructor() {
                this.messages = [];
                this.files = {};
                this.sessionId = null;
                this.processing = false;
                this.networkData = { nodes: [], edges: [] };
                this.networkInstance = null;
                this.websocket = null;
                this.currentStreamingMessageId = null;
                this.useWebSocket = true;
                this.isResizing = false;
                this.chatPanelWidth = 50;
                this.chatFullscreen = false;
                this.graphFullscreen = false;
                this.activeTab = 'graph';
                
                this.init();
                this.initResize();
                this.veraRobot = new VeraRobot('vera-robot');

                this.toolchainWebSocket = null;
                this.currentExecution = null;
                this.toolchainExecutions = [];

                this.focusWebSocket = null;
                this.currentFocus = null;
                this.focusBoard = {
                    progress: [],
                    next_steps: [],
                    issues: [],
                    ideas: [],
                    actions: []
                };
                this.focusRunning = false;

                this.memoryEntities = [];
                this.memoryRelationships = [];
                this.memoryQueryResults = null;
                
            }
            
            async init() {
                try {
                    
                    const response = await fetch('http://llm.int:8888/api/session/start', { method: 'POST' });
                    const data = await response.json();
                    this.sessionId = data.session_id;
                    
                    document.getElementById('sessionInfo').textContent = `Session: ${this.sessionId}`;
                    document.getElementById('connectionStatus').innerHTML = '<span class="status-indicator connected"></span>Connected';
                    
                    this.initGraph();
                    this.addSystemMessage('Vera connected and ready!');
                    
                    document.getElementById('messageInput').focus();
                    
                    if (this.useWebSocket) {
                        this.connectWebSocket();
                        this.connectToolchainWebSocket(); 
                        this.connectFocusWebSocket();
                    }
                } catch (error) {
                    console.error('Init error:', error);
                    document.getElementById('connectionStatus').innerHTML = '<span class="status-indicator disconnected"></span>Offline';
                    this.addSystemMessage('Connection failed. Running in offline mode.');
                    this.veraRobot.setState('error');
                }

                const input = document.getElementById('messageInput');
                input.addEventListener('input', () => {
                    input.style.height = 'auto';
                    input.style.height = Math.min(input.scrollHeight, 200) + 'px';
                });
                
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
            }
            
            initResize() {
                const resizer = document.getElementById('resizer');
                const chatPanel = document.getElementById('chatPanel');
                const graphPanel = document.getElementById('graphPanel');
                const mainContent = document.querySelector('.main-content');
                
                let startX, startChatWidth;
                
                const startResize = (e) => {
                    this.isResizing = true;
                    startX = e.clientX;
                    startChatWidth = chatPanel.offsetWidth;
                    resizer.classList.add('resizing');
                    document.body.style.cursor = 'col-resize';
                    document.body.style.userSelect = 'none';
                };
                
                const doResize = (e) => {
                    if (!this.isResizing) return;
                    
                    const deltaX = e.clientX - startX;
                    const newChatWidth = startChatWidth + deltaX;
                    const containerWidth = mainContent.offsetWidth;
                    const percentage = (newChatWidth / containerWidth) * 100;
                    
                    if (percentage >= 20 && percentage <= 80) {
                        this.chatPanelWidth = percentage;
                        chatPanel.style.width = `${percentage}%`;
                        graphPanel.style.width = `${100 - percentage}%`;
                        resizer.style.left = `${percentage}%`;
                        
                        if (this.networkInstance) {
                            this.networkInstance.redraw();
                        }
                    }
                };
                
                const stopResize = () => {
                    this.isResizing = false;
                    resizer.classList.remove('resizing');
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                };
                
                resizer.addEventListener('mousedown', startResize);
                document.addEventListener('mousemove', doResize);
                document.addEventListener('mouseup', stopResize);
            }
            
            testPanel() {
                console.log('Test button clicked');
                const panel = document.getElementById('property-panel');
                console.log('Panel element:', panel);
                panel.classList.add('active');
                console.log('Panel classes:', panel.className);
                
                const content = document.getElementById('panel-content');
                content.innerHTML = '<div style="padding: 20px;"><h3 style="color: #60a5fa;">Test Panel</h3><p>If you see this, the panel HTML/CSS is working correctly!</p></div>';
            }            


            // Update the existing switchTab method:
            switchTab(tabName) {
                this.activeTab = tabName;
                
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                
                event.target.classList.add('active');
                document.getElementById(`tab-${tabName}`).classList.add('active');
                
                if (tabName === 'graph' && this.networkInstance) {
                    setTimeout(() => this.networkInstance.redraw(), 100);
                }
                
                if (tabName === 'toolchain') {
                    this.updateToolchainUI();
                }
                
                if (tabName === 'orchestration') {
                    this.loadFocusStatus();
                }
                
                if (tabName === 'memory') {
                    this.loadMemoryData();
                }
            }

            toggleFullscreen(panel) {
                const chatPanel = document.getElementById('chatPanel');
                const graphPanel = document.getElementById('graphPanel');
                const chatBtn = document.getElementById('chatFullscreenBtn');
                const graphBtn = document.getElementById('graphFullscreenBtn');
                
                if (panel === 'chat') {
                    this.chatFullscreen = !this.chatFullscreen;
                    
                    if (this.chatFullscreen) {
                        chatPanel.classList.add('fullscreen');
                        chatBtn.textContent = '‚õ∂ Exit';
                        this.graphFullscreen = false;
                        graphPanel.classList.remove('fullscreen');
                    } else {
                        chatPanel.classList.remove('fullscreen');
                        chatBtn.textContent = '‚õ∂';
                    }
                } else if (panel === 'graph') {
                    this.graphFullscreen = !this.graphFullscreen;
                    
                    if (this.graphFullscreen) {
                        graphPanel.classList.add('fullscreen');
                        graphBtn.textContent = '‚õ∂ Exit';
                        this.chatFullscreen = false;
                        chatPanel.classList.remove('fullscreen');
                        
                        setTimeout(() => {
                            if (this.networkInstance) {
                                this.networkInstance.redraw();
                                this.networkInstance.fit();
                            }
                        }, 350);
                    } else {
                        graphPanel.classList.remove('fullscreen');
                        graphBtn.textContent = '‚õ∂';
                        
                        setTimeout(() => {
                            if (this.networkInstance) {
                                this.networkInstance.redraw();
                            }
                        }, 350);
                    }
                }
            }
            
            connectWebSocket() {
                if (!this.sessionId) return;
                
                const wsUrl = `ws://llm.int:8888/ws/chat/${this.sessionId}`;
                this.websocket = new WebSocket(wsUrl);
                
                this.websocket.onopen = () => {
                    console.log('WebSocket connected');
                    document.getElementById('connectionStatus').innerHTML = '<span class="status-indicator connected"></span>Connected (WS)';
                    this.veraRobot.setState('idle');
                };
                
                this.websocket.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        this.handleWebSocketMessage(data);
                    } catch (error) {
                        console.error('WebSocket message parse error:', error);
                    }
                };
                
                this.websocket.onerror = (error) => {
                    console.error('WebSocket error:', error);
                };
                
                this.websocket.onclose = (event) => {
                    console.log('WebSocket disconnected');
                    document.getElementById('connectionStatus').innerHTML = '<span class="status-indicator disconnected"></span>Disconnected';
                    
                    if (event.code !== 1000 && this.sessionId) {
                        setTimeout(() => this.connectWebSocket(), 3000);
                    }
                };
            }
            
            handleWebSocketMessage(data) {
                this.veraRobot.setState('thinking');
                if (data.type === 'chunk') {
                    if (!this.currentStreamingMessageId) {
                        this.currentStreamingMessageId = `msg-${Date.now()}`;
                        this.addMessage('assistant', '', this.currentStreamingMessageId);
                    }
                    
                    const message = this.messages.find(m => m.id === this.currentStreamingMessageId);
                    if (message) {
                        message.content += data.content;
                        this.updateStreamingMessageContent(this.currentStreamingMessageId, message.content);
                    }
                } else if (data.type === 'complete') {
                    this.veraRobot.setState('idle');
                    this.currentStreamingMessageId = null;
                    this.processing = false;
                    document.getElementById('sendBtn').disabled = false;
                    document.getElementById('messageInput').disabled = false;
                    document.getElementById('messageInput').focus();
                    this.loadGraph();
                } else if (data.type === 'error') {
                    this.veraRobot.setState('error');
                    this.addSystemMessage(`Error: ${data.error}`);
                    this.currentStreamingMessageId = null;
                    this.processing = false;
                    document.getElementById('sendBtn').disabled = false;
                    document.getElementById('messageInput').disabled = false;
                }
            }
            
            updateStreamingMessageContent(messageId, content) {
                const messageEl = document.getElementById(messageId);
                if (!messageEl) return;
                
                const contentEl = messageEl.querySelector('.message-content');
                if (contentEl) {
                    // Update the first word before displaying
                    const updatedContent = content.replace(/^(\w+)/, '**Agent: $1**');
                    contentEl.innerHTML = this.parseMessageContent(updatedContent);
                    
                    const container = document.getElementById('chatMessages');
                    const isScrolledToBottom = container.scrollHeight - container.clientHeight <= container.scrollTop + 50;
                    
                    if (isScrolledToBottom) {
                        container.scrollTop = container.scrollHeight;
                    }
                }
            }
            
            async sendMessageViaWebSocket(message) {
                this.veraRobot.setState('thinking');
                if (!this.websocket || this.websocket.readyState !== WebSocket.OPEN) {
                    return false;
                }
                
                try {
                    this.websocket.send(JSON.stringify({
                        message: message,
                        files: Object.keys(this.files)
                    }));
                    return true;
                } catch (error) {
                    console.error('WebSocket send error:', error);
                    return false;
                }
            }
            
            initGraph() {
                const container = document.getElementById('graph');
                const options = {
                    physics: {
                        enabled: true,
                        barnesHut: {
                            gravitationalConstant: -9000,
                            centralGravity: 0.06,
                            springLength: 300,
                            springConstant: 0.01,
                            damping: 0.62
                        },
                        stabilization: {
                            enabled: true,
                            iterations: 200
                        }
                    },
                    interaction: {
                        hover: true,
                        navigationButtons: true,
                        zoomView: true,
                        dragView: true
                    },
                    edges: {
                        smooth: { enabled: true, type: 'dynamic' },
                        // color: { color: '#ffffff', hover: '#ffaa00' },
                        font:  {color: '#ffffff', strokeWidth: 0, size: 12 },
                        width: 2,
                        arrows: { to: { enabled: true, scaleFactor: 1.0 } }
                    },
                    nodes: {
                        color: {
                            border: '#60a5fa',
                            highlight: { border: '#60a5fa' }
                        },
                        font: { color: '#fff', size: 13 }
                    }
                };
                
                this.networkInstance = new vis.Network(container, this.networkData, options);
                window.network = this.networkInstance;
                
                console.log('Network created:', !!this.networkInstance);
                
                // Initialize GraphAddon first
                setTimeout(() => {
                    console.log('Checking for GraphAddon...');
                    if (window.GraphAddon) {
                        console.log('GraphAddon found, initializing...');
                        window.GraphAddon.init({});
                        console.log('GraphAddon initialized');
                        
                        // Wait a bit more for GraphAddon to fully set up
                        setTimeout(() => {
                            console.log('Setting up our click handler...');
                            
                            // Remove GraphAddon's click handler and add our own
                            this.networkInstance.off("click");
                            
                            this.networkInstance.on("click", (params) => {
                                console.log('=== OUR CLICK HANDLER ===');
                                console.log('Nodes clicked:', params.nodes);
                                
                                if (params.nodes.length > 0) {
                                    const nodeId = params.nodes[0];
                                    console.log('Opening panel for node:', nodeId);
                                    
                                    // Force open the panel
                                    const panel = document.getElementById('property-panel');
                                    panel.classList.add('active');
                                    panel.style.right = '0';
                                    console.log('Panel forced open, classes:', panel.className);
                                    
                                    // Call GraphAddon to populate content
                                    if (window.GraphAddon && window.GraphAddon.showNodeDetails) {
                                        window.GraphAddon.showNodeDetails(nodeId, true);
                                        console.log('Content populated');
                                    }
                                } else if (params.edges.length > 0) {
                                    // Handle edge clicks
                                    const panel = document.getElementById('property-panel');
                                    panel.classList.add('active');
                                    
                                    if (window.GraphAddon && window.GraphAddon.showEdgeDetails) {
                                        window.GraphAddon.showEdgeDetails(params.edges[0]);
                                    }
                                } else {
                                    // Clicking empty space - close panel
                                    const panel = document.getElementById('property-panel');
                                    panel.classList.remove('active');
                                    console.log('Panel closed');
                                }
                            });
                            
                            console.log('Click handler installed');
                        }, 1000);
                    } else {
                        console.error('GraphAddon not available! Is graph-addon.js loaded?');
                    }
                }, 500);
            }
            
            async loadGraph() {
                if (!this.sessionId) return;
                
                try {
                    const response = await fetch(`http://llm.int:8888/api/graph/session/${this.sessionId}`);
                    const data = await response.json();
                    
                    console.log('Graph data received:', data.nodes.length, 'nodes', data.edges.length, 'edges');
                    
                    this.networkData.nodes = data.nodes.map(n => ({
                        id: n.id,
                        label: n.label,
                        title: n.title,
                        properties: n.properties,
                        type: n.type || n.labels,
                        color: n.color || '#3b82f6',
                        size: n.size || 25
                    }));
                    
                    this.networkData.edges = data.edges.map(e => ({
                        id: e.id || `${e.from}-${e.to}`,
                        from: e.from,
                        to: e.to,
                        label: e.label,
                        title: e.label
                    }));
                    
                    if (this.networkInstance) {
                        this.networkInstance.setData(this.networkData);
                        
                        setTimeout(() => {
                            this.networkInstance.redraw();
                            this.networkInstance.fit();
                        }, 100);
                    }
                    
                    document.getElementById('nodeCount').textContent = data.nodes.length;
                    document.getElementById('edgeCount').textContent = data.edges.length;
                    
                    if (window.GraphAddon) {
                        setTimeout(() => {
                            console.log('Updating GraphAddon data...');
                            window.GraphAddon.buildNodesData();
                            window.GraphAddon.initializeFilters();
                        }, 500);
                    }
                } catch (error) {
                    console.error('Graph load error:', error);
                }
            }
            
            async sendMessage() {
                const input = document.getElementById('messageInput');
                const message = input.value.trim();
                
                if (!message || this.processing) return;
                
                this.processing = true;
                document.getElementById('sendBtn').disabled = true;
                input.disabled = true;
                
                this.addMessage('user', message);
                input.value = '';
                input.style.height = 'auto';
                
                if (this.useWebSocket) {
                    const sent = await this.sendMessageViaWebSocket(message);
                    if (sent) return;
                }
                
                try {
                    const response = await fetch('http://llm.int:8888/api/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            session_id: this.sessionId,
                            message: message,
                            files: Object.keys(this.files)
                        })
                    });
                    
                    const data = await response.json();
                    const responseText = typeof data.response === 'string' ? data.response : JSON.stringify(data.response);
                    
                    this.addMessage('assistant', responseText);
                    await this.loadGraph();
                } catch (error) {
                    console.error('Send error:', error);
                    this.addSystemMessage(`Error: ${error.message}`);
                }
                
                this.processing = false;
                document.getElementById('sendBtn').disabled = false;
                input.disabled = false;
                input.focus();
            }
            
            addMessage(role, content, id = null) {
                const messageId = id || `msg-${Date.now()}`;
                const message = { id: messageId, role, content, timestamp: new Date() };
                this.messages.push(message);
                this.renderMessage(message);
            }
            
            escapeHtml(unsafe) {
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }
            
            parseMessageContent(content) {
                if (typeof content === 'object' && content !== null) {
                    if (Array.isArray(content)) {
                        content = content.filter(item => typeof item === 'string').join('\n');
                    } else {
                        content = content.deep || content.fast || Object.values(content).filter(value => typeof value === 'string').join('\n');
                    }
                }
                
                content = String(content).replace(/\\n/g, '\n').replace(/\\'/g, "'").replace(/\\"/g, '"');
                
                const codeBlocks = [];
                const inlineCodes = [];
                const links = [];
                
                content = content.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
                    const language = lang || 'code';
                    const escapedCode = this.escapeHtml(code.trim());
                    const placeholder = `###CODEBLOCK${codeBlocks.length}###`;
                    codeBlocks.push(`<div style="position: relative; background: #0f172a; border-radius: 4px; padding: 10px; margin: 8px 0;"><div style="display: flex; justify-content: space-between; margin-bottom: 6px;"><div style="color: #94a3b8; font-size: 11px; text-transform: uppercase;">${language}</div><button onclick="app.copyCode(this)" style="background: #334155; border: none; color: #cbd5e1; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">Copy</button></div><pre style="margin: 0; color: #e2e8f0; font-family: monospace; font-size: 12px; white-space: pre-wrap;">${escapedCode}</pre></div>`);
                    return placeholder;
                });
                
                content = content.replace(/`([^`]+)`/g, (match, code) => {
                    const placeholder = `###INLINECODE${inlineCodes.length}###`;
                    inlineCodes.push(`<code style="background: #0f172a; padding: 2px 6px; border-radius: 3px; color: #a78bfa; font-family: monospace; font-size: 12px;">${this.escapeHtml(code)}</code>`);
                    return placeholder;
                });
                
                content = content.replace(/\[([^\]]+)\]\(([^)]+)\)/g, (match, text, url) => {
                    const placeholder = `###LINK${links.length}###`;
                    links.push(`<a href="${this.escapeHtml(url)}" target="_blank" style="color: #3b82f6; text-decoration: underline;">${this.escapeHtml(text)}</a>`);
                    return placeholder;
                });
                
                content = content.replace(/https?:\/\/[^\s<]+[^<.,:;"')\]\s]/g, (url) => {
                    const placeholder = `###LINK${links.length}###`;
                    links.push(`<a href="${url}" target="_blank" style="color: #3b82f6; text-decoration: underline;">${url}</a>`);
                    return placeholder;
                });
                
                content = this.escapeHtml(content);
                
                content = content.replace(/^### (.+)$/gm, '<h3 style="font-size: 16px; font-weight: 600; margin: 12px 0 8px 0;">$1</h3>');
                content = content.replace(/^## (.+)$/gm, '<h2 style="font-size: 18px; font-weight: 600; margin: 14px 0 10px 0;">$1</h2>');
                content = content.replace(/^# (.+)$/gm, '<h1 style="font-size: 20px; font-weight: 600; margin: 16px 0 12px 0;">$1</h1>');
                content = content.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
                content = content.replace(/__(?!#)([^_]+)__/g, '<strong>$1</strong>');
                content = content.replace(/(?<!\*)(\*)(?!\*)([^*]+)(?<!\*)(\*)(?!\*)/g, '<em>$2</em>');
                content = content.replace(/^[\*\-\+] (.+)$/gm, '<li style="margin-left: 20px;">$1</li>');
                content = content.replace(/^(\d+)\. (.+)$/gm, '<li style="margin-left: 20px; list-style-type: decimal;">$2</li>');
                content = content.replace(/(<li[^>]*>.*?<\/li>\n?)+/g, (match) => {
                    return match.includes('decimal') ? '<ol style="margin: 8px 0;">' + match + '</ol>' : '<ul style="margin: 8px 0;">' + match + '</ul>';
                });
                content = content.replace(/^&gt; (.+)$/gm, '<blockquote style="border-left: 3px solid #60a5fa; padding-left: 12px; margin: 8px 0; color: #94a3b8; font-style: italic;">$1</blockquote>');
                content = content.replace(/^---$/gm, '<hr style="border: none; border-top: 1px solid #334155; margin: 12px 0;">');
                content = content.replace(/\n/g, '<br>');
                
                codeBlocks.forEach((block, i) => content = content.replace(`###CODEBLOCK${i}###`, block));
                inlineCodes.forEach((code, i) => content = content.replace(`###INLINECODE${i}###`, code));
                links.forEach((link, i) => content = content.replace(`###LINK${i}###`, link));
                
                return content;
            }
            
            copyCode(button) {
                const codeBlock = button.closest('div').querySelector('pre');
                const code = codeBlock.textContent;
                navigator.clipboard.writeText(code).then(() => {
                    const originalText = button.textContent;
                    button.textContent = 'Copied!';
                    setTimeout(() => button.textContent = originalText, 2000);
                });
            }
            
            copyMessage(button) {
                const messageContent = button.closest('.message').querySelector('.message-content');
                const text = messageContent.innerText;
                navigator.clipboard.writeText(text).then(() => {
                    const originalText = button.textContent;
                    button.textContent = '‚úì';
                    setTimeout(() => button.textContent = originalText, 2000);
                });
            }
            
            renderMessage(message) {
                const container = document.getElementById('chatMessages');
                const messageEl = document.createElement('div');
                messageEl.id = message.id;
                messageEl.className = `message ${message.role}`;
                
                const avatar = document.createElement('div');
                avatar.className = 'message-avatar';
                avatar.textContent = message.role === 'user' ? 'You' : message.role === 'system' ? '‚ÑπÔ∏è' : 'V';
                
                const content = document.createElement('div');
                content.className = 'message-content';
                content.innerHTML = this.parseMessageContent(message.content);
                
                if (message.role !== 'system') {
                    const copyBtn = document.createElement('button');
                    copyBtn.className = 'message-copy-btn';
                    copyBtn.textContent = 'üìã';
                    copyBtn.title = 'Copy message';
                    copyBtn.onclick = () => this.copyMessage(copyBtn);
                    content.appendChild(copyBtn);
                }
                
                if (message.role !== 'system') {
                    messageEl.appendChild(avatar);
                }
                messageEl.appendChild(content);
                
                container.appendChild(messageEl);
                container.scrollTop = container.scrollHeight;
            }
            
            addSystemMessage(content) {
                this.addMessage('system', content);
            }
            
            clearChat() {
                if (confirm('Clear all messages?')) {
                    this.messages = [];
                    document.getElementById('chatMessages').innerHTML = '';
                    this.addSystemMessage('Chat cleared');
                }
            }
            
            exportChat() {
                const data = {
                    session_id: this.sessionId,
                    messages: this.messages,
                    export_time: new Date().toISOString()
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `vera_chat_${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);
            }
            
            fitGraph() {
                if (this.networkInstance) {
                    this.networkInstance.fit();
                }
            }
            
            zoomIn() {
                if (this.networkInstance) {
                    const scale = this.networkInstance.getScale();
                    this.networkInstance.moveTo({ scale: scale * 1.2 });
                }
            }
            
            zoomOut() {
                if (this.networkInstance) {
                    const scale = this.networkInstance.getScale();
                    this.networkInstance.moveTo({ scale: scale * 0.8 });
                }
            }
            connectToolchainWebSocket() {
                if (!this.sessionId) return;
                
                const wsUrl = `ws://llm.int:8888/ws/toolchain/${this.sessionId}`;
                this.toolchainWebSocket = new WebSocket(wsUrl);
                
                this.toolchainWebSocket.onopen = () => {
                    console.log('Toolchain WebSocket connected');
                };
                
                this.toolchainWebSocket.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        this.handleToolchainEvent(data);
                    } catch (error) {
                        console.error('Toolchain WebSocket message parse error:', error);
                    }
                };
                
                this.toolchainWebSocket.onerror = (error) => {
                    console.error('Toolchain WebSocket error:', error);
                };
                
                this.toolchainWebSocket.onclose = () => {
                    console.log('Toolchain WebSocket disconnected');
                    if (this.sessionId) {
                        setTimeout(() => this.connectToolchainWebSocket(), 3000);
                    }
                };
            }

            // Add this method to handle toolchain events
            handleToolchainEvent(data) {
                console.log('Toolchain event:', data.type, data);
                
                switch (data.type) {
                    case 'execution_started':
                        this.currentExecution = {
                            id: data.data.execution_id,
                            query: data.data.query,
                            status: 'planning',
                            steps: [],
                            startTime: new Date(data.timestamp)
                        };
                        this.updateToolchainUI();
                        break;
                        
                    case 'status':
                        if (this.currentExecution) {
                            this.currentExecution.status = data.data.status;
                            this.updateToolchainUI();
                        }
                        break;
                        
                    case 'plan_chunk':
                        // Optional: Show plan generation in real-time
                        break;
                        
                    case 'plan':
                        if (this.currentExecution) {
                            this.currentExecution.plan = data.data.plan;
                            this.currentExecution.totalSteps = data.data.total_steps;
                            this.updateToolchainUI();
                        }
                        break;
                        
                    case 'step_started':
                        if (this.currentExecution) {
                            const step = {
                                number: data.data.step_number,
                                toolName: data.data.tool_name,
                                input: data.data.tool_input,
                                status: 'running',
                                output: '',
                                startTime: new Date(data.timestamp)
                            };
                            this.currentExecution.steps.push(step);
                            this.updateToolchainUI();
                        }
                        break;
                        
                    case 'step_output':
                        if (this.currentExecution) {
                            const step = this.currentExecution.steps.find(s => s.number === data.data.step_number);
                            if (step) {
                                step.output += data.data.chunk;
                                this.updateToolchainUI();
                            }
                        }
                        break;
                        
                    case 'step_completed':
                        if (this.currentExecution) {
                            const step = this.currentExecution.steps.find(s => s.number === data.data.step_number);
                            if (step) {
                                step.status = 'completed';
                                step.endTime = new Date(data.timestamp);
                                this.updateToolchainUI();
                            }
                        }
                        break;
                        
                    case 'step_failed':
                        if (this.currentExecution) {
                            const step = this.currentExecution.steps.find(s => s.number === data.data.step_number);
                            if (step) {
                                step.status = 'failed';
                                step.error = data.data.error;
                                step.endTime = new Date(data.timestamp);
                                this.updateToolchainUI();
                            }
                        }
                        break;
                        
                    case 'execution_completed':
                        if (this.currentExecution) {
                            this.currentExecution.status = 'completed';
                            this.currentExecution.finalResult = data.data.final_result;
                            this.currentExecution.endTime = new Date(data.timestamp);
                            this.toolchainExecutions.push(this.currentExecution);
                            this.updateToolchainUI();
                        }
                        break;
                        
                    case 'execution_failed':
                        if (this.currentExecution) {
                            this.currentExecution.status = 'failed';
                            this.currentExecution.error = data.data.error;
                            this.currentExecution.endTime = new Date(data.timestamp);
                            this.toolchainExecutions.push(this.currentExecution);
                            this.updateToolchainUI();
                        }
                        break;
                }
            }

            // Add this method to update the toolchain UI
            updateToolchainUI() {
                const container = document.getElementById('tab-toolchain');
                if (!container || this.activeTab !== 'toolchain') return;
                
                if (!this.currentExecution && this.toolchainExecutions.length === 0) {
                    container.innerHTML = `
                        <div style="padding: 20px;">
                            <h2 style="color: #60a5fa; margin-bottom: 16px;">Toolchain Monitor</h2>
                            <p style="color: #94a3b8;">No toolchain executions yet. Send a message that requires multiple tools.</p>
                        </div>
                    `;
                    return;
                }
                
                let html = `
                    <div style="padding: 20px; overflow-y: auto; height: 100%;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 style="color: #60a5fa; margin: 0;">Toolchain Monitor</h2>
                            <button class="panel-btn" onclick="app.loadToolchainHistory()">üìú History</button>
                        </div>
                `;
                
                // Show current execution
                if (this.currentExecution) {
                    const statusColor = this.currentExecution.status === 'completed' ? '#10b981' :
                                    this.currentExecution.status === 'failed' ? '#ef4444' :
                                    this.currentExecution.status === 'executing' ? '#3b82f6' : '#f59e0b';
                    
                    html += `
                        <div style="background: #1e293b; border-radius: 8px; padding: 16px; margin-bottom: 16px; border-left: 4px solid ${statusColor};">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                <div style="font-weight: 600; color: #e2e8f0;">Current Execution</div>
                                <div style="color: ${statusColor}; font-size: 12px; text-transform: uppercase;">${this.currentExecution.status}</div>
                            </div>
                            <div style="color: #94a3b8; font-size: 13px; margin-bottom: 8px;">${this.escapeHtml(this.currentExecution.query)}</div>
                            ${this.currentExecution.totalSteps ? `<div style="color: #94a3b8; font-size: 12px;">Steps: ${this.currentExecution.steps.length}/${this.currentExecution.totalSteps}</div>` : ''}
                        </div>
                    `;
                    
                    // Show plan if available
                    if (this.currentExecution.plan) {
                        html += `
                            <div style="background: #0f172a; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                                <div style="font-weight: 600; color: #60a5fa; margin-bottom: 12px;">Execution Plan</div>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                        `;
                        
                        this.currentExecution.plan.forEach((step, i) => {
                            html += `
                                <div style="background: #1e293b; padding: 10px; border-radius: 6px; border-left: 3px solid #8b5cf6;">
                                    <div style="color: #a78bfa; font-size: 11px; margin-bottom: 4px;">Step ${i + 1}</div>
                                    <div style="color: #e2e8f0; font-size: 13px; font-weight: 600;">${this.escapeHtml(step.tool)}</div>
                                    <div style="color: #94a3b8; font-size: 12px; margin-top: 4px;">${this.escapeHtml(step.input)}</div>
                                </div>
                            `;
                        });
                        
                        html += `</div></div>`;
                    }
                    
                    // Show steps execution
                    if (this.currentExecution.steps.length > 0) {
                        html += `
                            <div style="background: #0f172a; border-radius: 8px; padding: 16px;">
                                <div style="font-weight: 600; color: #60a5fa; margin-bottom: 12px;">Step Execution</div>
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                        `;
                        
                        this.currentExecution.steps.forEach(step => {
                            const stepStatusColor = step.status === 'completed' ? '#10b981' :
                                                step.status === 'failed' ? '#ef4444' : '#3b82f6';
                            
                            html += `
                                <div style="background: #1e293b; border-radius: 6px; overflow: hidden;">
                                    <div style="padding: 12px; border-left: 4px solid ${stepStatusColor};">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                            <div style="color: #e2e8f0; font-weight: 600;">Step ${step.number}: ${this.escapeHtml(step.toolName)}</div>
                                            <div style="color: ${stepStatusColor}; font-size: 11px; text-transform: uppercase;">${step.status}</div>
                                        </div>
                                        
                                        <div style="background: #0f172a; padding: 8px; border-radius: 4px; margin-bottom: 8px;">
                                            <div style="color: #60a5fa; font-size: 11px; margin-bottom: 4px;">Input:</div>
                                            <div style="color: #cbd5e1; font-size: 12px; font-family: monospace;">${this.escapeHtml(step.input.substring(0, 200))}${step.input.length > 200 ? '...' : ''}</div>
                                        </div>
                                        
                                        ${step.output ? `
                                            <div style="background: #0f172a; padding: 8px; border-radius: 4px;">
                                                <div style="color: #10b981; font-size: 11px; margin-bottom: 4px;">Output:</div>
                                                <div style="color: #cbd5e1; font-size: 12px; font-family: monospace; max-height: 150px; overflow-y: auto;">${this.escapeHtml(step.output)}</div>
                                            </div>
                                        ` : ''}
                                        
                                        ${step.error ? `
                                            <div style="background: #7f1d1d; padding: 8px; border-radius: 4px; margin-top: 8px;">
                                                <div style="color: #fca5a5; font-size: 11px; margin-bottom: 4px;">Error:</div>
                                                <div style="color: #fecaca; font-size: 12px;">${this.escapeHtml(step.error)}</div>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                        });
                        
                        html += `</div></div>`;
                    }
                }
                
                html += `</div>`;
                container.innerHTML = html;
            }

            // Add this method to load toolchain history
            async loadToolchainHistory() {
                if (!this.sessionId) return;
                
                try {
                    const response = await fetch(`http://llm.int:8888/api/toolchain/${this.sessionId}/executions`);
                    const data = await response.json();
                    
                    this.toolchainExecutions = data.executions;
                    
                    // Show history in a modal or side panel
                    const container = document.getElementById('tab-toolchain');
                    let html = `
                        <div style="padding: 20px; overflow-y: auto; height: 100%;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h2 style="color: #60a5fa; margin: 0;">Toolchain History</h2>
                                <button class="panel-btn" onclick="app.updateToolchainUI()">‚Üê Back</button>
                            </div>
                    `;
                    
                    if (this.toolchainExecutions.length === 0) {
                        html += `<p style="color: #94a3b8;">No execution history.</p>`;
                    } else {
                        html += `<div style="display: flex; flex-direction: column; gap: 12px;">`;
                        
                        this.toolchainExecutions.forEach(exec => {
                            const statusColor = exec.status === 'completed' ? '#10b981' :
                                            exec.status === 'failed' ? '#ef4444' : '#f59e0b';
                            
                            html += `
                                <div style="background: #1e293b; border-radius: 8px; padding: 16px; border-left: 4px solid ${statusColor}; cursor: pointer;" onclick="app.viewExecution('${exec.execution_id}')">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <div style="color: #e2e8f0; font-weight: 600;">${this.escapeHtml(exec.query.substring(0, 60))}...</div>
                                        <div style="color: ${statusColor}; font-size: 12px;">${exec.status}</div>
                                    </div>
                                    <div style="color: #94a3b8; font-size: 12px;">
                                        Steps: ${exec.completed_steps}/${exec.total_steps} ‚Ä¢ 
                                        ${new Date(exec.start_time).toLocaleString()}
                                    </div>
                                </div>
                            `;
                        });
                        
                        html += `</div>`;
                    }
                    
                    html += `</div>`;
                    container.innerHTML = html;
                    
                } catch (error) {
                    console.error('Failed to load toolchain history:', error);
                }
            }

            // Add this method to view a specific execution
            async viewExecution(executionId) {
                try {
                    const response = await fetch(`http://llm.int:8888/api/toolchain/${this.sessionId}/execution/${executionId}`);
                    const execution = await response.json();
                    
                    this.currentExecution = execution;
                    this.updateToolchainUI();
                    
                } catch (error) {
                    console.error('Failed to load execution:', error);
                }
            }
            // Add this method to connect focus WebSocket
            connectFocusWebSocket() {
                if (!this.sessionId) return;
                
                const wsUrl = `ws://llm.int:8888/ws/focus/${this.sessionId}`;
                this.focusWebSocket = new WebSocket(wsUrl);
                
                this.focusWebSocket.onopen = () => {
                    console.log('Focus WebSocket connected');
                };
                
                this.focusWebSocket.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        this.handleFocusEvent(data);
                    } catch (error) {
                        console.error('Focus WebSocket message parse error:', error);
                    }
                };
                
                this.focusWebSocket.onerror = (error) => {
                    console.error('Focus WebSocket error:', error);
                };
                
                this.focusWebSocket.onclose = () => {
                    console.log('Focus WebSocket disconnected');
                    if (this.sessionId) {
                        setTimeout(() => this.connectFocusWebSocket(), 3000);
                    }
                };
            }

            // Add this method to handle focus events
            handleFocusEvent(data) {
                console.log('Focus event:', data.type, data);
                
                switch (data.type) {
                    case 'focus_status':
                        this.currentFocus = data.data.focus;
                        this.focusBoard = data.data.focus_board;
                        this.focusRunning = data.data.running;
                        this.updateFocusUI();
                        break;
                        
                    case 'focus_changed':
                        this.currentFocus = data.data.focus;
                        this.updateFocusUI();
                        this.addSystemMessage(`Focus changed to: ${data.data.focus}`);
                        break;
                        
                    case 'board_updated':
                        this.focusBoard = data.data.focus_board;
                        this.updateFocusUI();
                        break;
                        
                    case 'proactive_thought':
                        this.addSystemMessage(`üí° Proactive thought: ${data.data.thought}`);
                        this.updateFocusUI();
                        break;
                }
            }

            // Add this method to update focus UI
            updateFocusUI() {
                const container = document.getElementById('tab-orchestration');
                if (!container || this.activeTab !== 'orchestration') return;
                
                let html = `
                    <div style="padding: 20px; overflow-y: auto; height: 100%;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 style="color: #60a5fa; margin: 0;">Proactive Focus Manager</h2>
                            <div style="display: flex; gap: 8px;">
                                <span style="padding: 6px 12px; background: ${this.focusRunning ? '#10b981' : '#6b7280'}; color: white; border-radius: 6px; font-size: 12px;">
                                    ${this.focusRunning ? '‚óè Running' : '‚óã Stopped'}
                                </span>
                                <button class="panel-btn" onclick="app.loadFocusStatus()">üîÑ Refresh</button>
                            </div>
                        </div>
                `;
                
                // Current Focus section
                html += `
                    <div style="background: #1e293b; border-radius: 8px; padding: 16px; margin-bottom: 16px; border-left: 4px solid #8b5cf6;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div style="font-weight: 600; color: #e2e8f0; font-size: 14px;">Current Focus</div>
                            <div style="display: flex; gap: 8px;">
                                <button class="panel-btn" style="font-size: 11px;" onclick="app.showSetFocusDialog()">‚úèÔ∏è Set</button>
                                ${this.currentFocus ? `<button class="panel-btn" style="font-size: 11px;" onclick="app.clearFocus()">‚úï Clear</button>` : ''}
                            </div>
                        </div>
                `;
                
                if (this.currentFocus) {
                    html += `
                        <div style="background: #0f172a; padding: 12px; border-radius: 6px;">
                            <div style="color: #a78bfa; font-size: 18px; font-weight: 600;">${this.escapeHtml(this.currentFocus)}</div>
                        </div>
                    `;
                } else {
                    html += `
                        <div style="color: #94a3b8; font-size: 13px; font-style: italic;">No focus set. Set a focus to enable proactive thinking.</div>
                    `;
                }
                
                html += `</div>`;
                
                // Focus Board sections
                const categories = [
                    { key: 'actions', label: 'Actions', color: '#3b82f6', icon: '‚ö°' },
                    { key: 'progress', label: 'Progress', color: '#10b981', icon: '‚úì' },
                    { key: 'next_steps', label: 'Next Steps', color: '#f59e0b', icon: '‚Üí' },
                    { key: 'issues', label: 'Issues', color: '#ef4444', icon: '‚ö†' },
                    { key: 'ideas', label: 'Ideas', color: '#8b5cf6', icon: 'üí°' }
                ];
                
                html += `<div style="display: grid; grid-template-columns: 1fr; gap: 16px;">`;
                
                categories.forEach(cat => {
                    const items = this.focusBoard[cat.key] || [];
                    
                    html += `
                        <div style="background: #1e293b; border-radius: 8px; padding: 16px; border-left: 4px solid ${cat.color};">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <div style="font-weight: 600; color: #e2e8f0; font-size: 14px;">
                                    ${cat.icon} ${cat.label}
                                    <span style="color: #94a3b8; font-weight: normal; font-size: 12px; margin-left: 8px;">(${items.length})</span>
                                </div>
                                <button class="panel-btn" style="font-size: 11px;" onclick="app.addToFocusBoard('${cat.key}')">+ Add</button>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                    `;
                    
                    if (items.length === 0) {
                        html += `<div style="color: #64748b; font-size: 12px; font-style: italic;">No ${cat.label.toLowerCase()} yet.</div>`;
                    } else {
                        items.forEach((item, idx) => {
                            html += `
                                <div style="background: #0f172a; padding: 10px 12px; border-radius: 6px; border-left: 3px solid ${cat.color};">
                                    <div style="color: #cbd5e1; font-size: 13px;">${this.escapeHtml(item)}</div>
                                </div>
                            `;
                        });
                    }
                    
                    html += `</div></div>`;
                });
                
                html += `</div></div>`;
                
                container.innerHTML = html;
            }

            // Add method to load focus status
            async loadFocusStatus() {
                if (!this.sessionId) return;
                
                try {
                    const response = await fetch(`http://llm.int:8888/api/focus/${this.sessionId}`);
                    const data = await response.json();
                    
                    this.currentFocus = data.focus;
                    this.focusBoard = data.focus_board;
                    this.focusRunning = data.running;
                    
                    this.updateFocusUI();
                } catch (error) {
                    console.error('Failed to load focus status:', error);
                }
            }

            // Add method to show set focus dialog
            showSetFocusDialog() {
                const focus = prompt('Enter focus for proactive thinking:', this.currentFocus || '');
                if (focus !== null && focus.trim()) {
                    this.setFocus(focus.trim());
                }
            }

            // Add method to set focus
            async setFocus(focus) {
                if (!this.sessionId) return;
                
                try {
                    const response = await fetch(`http://llm.int:8888/api/focus/${this.sessionId}/set`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ focus: focus })
                    });
                    
                    const data = await response.json();
                    this.currentFocus = data.focus;
                    this.updateFocusUI();
                    this.addSystemMessage(`Focus set to: ${focus}`);
                } catch (error) {
                    console.error('Failed to set focus:', error);
                    this.addSystemMessage(`Error setting focus: ${error.message}`);
                }
            }

            // Add method to clear focus
            async clearFocus() {
                if (!this.sessionId) return;
                if (!confirm('Clear current focus?')) return;
                
                try {
                    await fetch(`http://llm.int:8888/api/focus/${this.sessionId}/clear`, {
                        method: 'POST'
                    });
                    
                    this.currentFocus = null;
                    this.updateFocusUI();
                    this.addSystemMessage('Focus cleared');
                } catch (error) {
                    console.error('Failed to clear focus:', error);
                }
            }

            // Add method to add to focus board
            async addToFocusBoard(category) {
                const note = prompt(`Add to ${category}:`);
                if (!note || !note.trim()) return;
                
                try {
                    const response = await fetch(`http://llm.int:8888/api/focus/${this.sessionId}/board/add`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            category: category,
                            note: note.trim()
                        })
                    });
                    
                    const data = await response.json();
                    this.focusBoard = data.focus_board;
                    this.updateFocusUI();
                } catch (error) {
                    console.error('Failed to add to focus board:', error);
                }
            }

            // Query memory with different retrieval modes
            async queryMemory(query, retrievalType = 'hybrid', k = 5) {
                if (!this.sessionId) return;
                
                try {
                    const response = await fetch('http://llm.int:8888/api/memory/query', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            session_id: this.sessionId,
                            query: query,
                            k: k,
                            retrieval_type: retrievalType,
                            filters: null
                        })
                    });
                    
                    const data = await response.json();
                    this.memoryQueryResults = data;
                    this.updateMemoryUI();
                    return data;
                } catch (error) {
                    console.error('Memory query error:', error);
                    this.addSystemMessage(`Memory query failed: ${error.message}`);
                }
            }

            // Advanced hybrid retrieval
            async hybridRetrieve(query, kVector = 5, kGraph = 3, graphDepth = 2) {
                if (!this.sessionId) return;
                
                try {
                    const response = await fetch('http://llm.int:8888/api/memory/hybrid-retrieve', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            session_id: this.sessionId,
                            query: query,
                            k_vector: kVector,
                            k_graph: kGraph,
                            graph_depth: graphDepth,
                            include_entities: true,
                            filters: null
                        })
                    });
                    
                    const data = await response.json();
                    this.memoryQueryResults = data;
                    this.updateMemoryUI();
                    return data;
                } catch (error) {
                    console.error('Hybrid retrieval error:', error);
                }
            }

            // Extract entities from text
            async extractEntities(text, autoPromote = false) {
                if (!this.sessionId) return;
                
                try {
                    const response = await fetch('http://llm.int:8888/api/memory/extract-entities', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            session_id: this.sessionId,
                            text: text,
                            auto_promote: autoPromote,
                            source_node_id: null
                        })
                    });
                    
                    const data = await response.json();
                    this.addSystemMessage(`Extracted ${data.entities.length} entities and ${data.relations.length} relationships`);
                    
                    // Reload graph to show new entities
                    await this.loadGraph();
                    return data;
                } catch (error) {
                    console.error('Entity extraction error:', error);
                }
            }

            // Load session entities
            async loadSessionEntities() {
                if (!this.sessionId) return;
                
                try {
                    const response = await fetch(`http://llm.int:8888/api/memory/${this.sessionId}/entities`);
                    const data = await response.json();
                    this.memoryEntities = data.entities;
                    this.updateMemoryUI();
                } catch (error) {
                    console.error('Failed to load entities:', error);
                }
            }

            // Load session relationships
            async loadSessionRelationships() {
                if (!this.sessionId) return;
                
                try {
                    const response = await fetch(`http://llm.int:8888/api/memory/${this.sessionId}/relationships`);
                    const data = await response.json();
                    this.memoryRelationships = data.relationships;
                    this.updateMemoryUI();
                } catch (error) {
                    console.error('Failed to load relationships:', error);
                }
            }

            // Get subgraph around entities
            async getMemorySubgraph(entityIds, depth = 2) {
                if (!this.sessionId) return;
                
                try {
                    const response = await fetch('http://llm.int:8888/api/memory/subgraph', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            session_id: this.sessionId,
                            seed_entity_ids: entityIds,
                            depth: depth
                        })
                    });
                    
                    const data = await response.json();
                    
                    // Visualize subgraph
                    if (data.subgraph && this.networkInstance) {
                        this.visualizeSubgraph(data.subgraph);
                    }
                    
                    return data;
                } catch (error) {
                    console.error('Subgraph retrieval error:', error);
                }
            }

            // Promote memory to long-term
            async promoteMemory(memoryId, entityAnchor = null) {
                if (!this.sessionId) return;
                
                try {
                    const response = await fetch(`http://llm.int:8888/api/memory/${this.sessionId}/promote`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            memory_id: memoryId,
                            entity_anchor: entityAnchor
                        })
                    });
                    
                    const data = await response.json();
                    this.addSystemMessage(`Memory promoted to long-term storage`);
                    return data;
                } catch (error) {
                    console.error('Memory promotion error:', error);
                }
            }

            // Visualize subgraph in network
            visualizeSubgraph(subgraph) {
                if (!this.networkInstance) return;
                
                const nodes = subgraph.nodes.map(n => ({
                    id: n.id,
                    label: n.properties?.text?.substring(0, 30) || n.id,
                    title: JSON.stringify(n.properties, null, 2),
                    color: n.properties?.type === 'extracted_entity' ? '#10b93a' : '#3b82f6',
                    size: 30
                }));
                
                const edges = subgraph.rels.map((r, idx) => ({
                    id: `subgraph-edge-${idx}`,
                    from: r.start,
                    to: r.end,
                    label: r.type || r.properties?.rel,
                    color: { color: '#f59e0b', highlight: '#fbbf24' },
                    width: 3
                }));
                
                // Highlight these nodes/edges in the existing graph
                this.networkInstance.selectNodes(nodes.map(n => n.id));
                
                // Or switch to subgraph view
                this.switchTab('graph');
                setTimeout(() => {
                    this.networkInstance.fit({
                        nodes: nodes.map(n => n.id),
                        animation: true
                    });
                }, 100);
            }

            // Update memory UI
            updateMemoryUI() {
                const container = document.getElementById('memory-content');
                if (!container || this.activeTab !== 'memory') return;
                
                let html = `
                    <div style="display: flex; flex-direction: column; gap: 20px;">
                        <!-- Memory Query Section -->
                        <div style="background: #1e293b; border-radius: 8px; padding: 16px;">
                            <h3 style="color: #60a5fa; margin-bottom: 12px; font-size: 16px;">üîç Memory Query</h3>
                            <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                                <input 
                                    type="text" 
                                    id="memory-query-input" 
                                    placeholder="Search memories..." 
                                    style="flex: 1; padding: 10px; background: #0f172a; border: 1px solid #334155; color: #e2e8f0; border-radius: 6px;"
                                >
                                <select 
                                    id="memory-retrieval-type" 
                                    style="padding: 10px; background: #0f172a; border: 1px solid #334155; color: #e2e8f0; border-radius: 6px;"
                                >
                                    <option value="hybrid">Hybrid</option>
                                    <option value="vector">Vector</option>
                                    <option value="graph">Graph</option>
                                </select>
                                <button 
                                    class="panel-btn" 
                                    onclick="app.performMemoryQuery()"
                                    style="padding: 10px 20px; font-size: 14px;"
                                >
                                    Search
                                </button>
                            </div>
                            
                            ${this.memoryQueryResults ? this.renderMemoryQueryResults() : '<p style="color: #94a3b8; font-size: 13px;">No query results yet</p>'}
                        </div>
                        
                        <!-- Entity Extraction Section -->
                        <div style="background: #1e293b; border-radius: 8px; padding: 16px;">
                            <h3 style="color: #60a5fa; margin-bottom: 12px; font-size: 16px;">üß† Entity Extraction</h3>
                            <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                                <textarea 
                                    id="entity-extract-input" 
                                    placeholder="Enter text to extract entities..." 
                                    rows="3"
                                    style="flex: 1; padding: 10px; background: #0f172a; border: 1px solid #334155; color: #e2e8f0; border-radius: 6px; resize: vertical;"
                                ></textarea>
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <label style="display: flex; align-items: center; gap: 8px; color: #cbd5e1; font-size: 13px;">
                                    <input type="checkbox" id="auto-promote-checkbox">
                                    Auto-promote high-confidence entities
                                </label>
                                <button 
                                    class="panel-btn" 
                                    onclick="app.performEntityExtraction()"
                                    style="margin-left: auto; padding: 10px 20px;"
                                >
                                    Extract
                                </button>
                            </div>
                        </div>
                        
                        <!-- Session Entities Section -->
                        <div style="background: #1e293b; border-radius: 8px; padding: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <h3 style="color: #60a5fa; margin: 0; font-size: 16px;">üì¶ Session Entities (${this.memoryEntities.length})</h3>
                                <button class="panel-btn" onclick="app.loadSessionEntities()">üîÑ Refresh</button>
                            </div>
                            
                            ${this.renderEntitiesList()}
                        </div>
                        
                        <!-- Session Relationships Section -->
                        <div style="background: #1e293b; border-radius: 8px; padding: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <h3 style="color: #60a5fa; margin: 0; font-size: 16px;">üîó Session Relationships (${this.memoryRelationships.length})</h3>
                                <button class="panel-btn" onclick="app.loadSessionRelationships()">üîÑ Refresh</button>
                            </div>
                            
                            ${this.renderRelationshipsList()}
                        </div>
                    </div>
                `;
                
                container.innerHTML = html;
            }

            // Render memory query results
            renderMemoryQueryResults() {
                if (!this.memoryQueryResults) return '';
                
                // Handle different result formats
                if (this.memoryQueryResults.results) {
                    // Simple query results
                    const results = this.memoryQueryResults.results;
                    if (results.length === 0) {
                        return '<p style="color: #94a3b8; font-size: 13px;">No results found</p>';
                    }
                    
                    let html = '<div style="display: flex; flex-direction: column; gap: 8px; max-height: 400px; overflow-y: auto;">';
                    results.forEach((result, idx) => {
                        html += `
                            <div style="background: #0f172a; padding: 12px; border-radius: 6px; border-left: 3px solid #3b82f6;">
                                <div style="color: #e2e8f0; font-size: 13px; margin-bottom: 4px;">${this.escapeHtml(result.text || result.id)}</div>
                                ${result.distance ? `<div style="color: #94a3b8; font-size: 11px;">Distance: ${result.distance.toFixed(3)}</div>` : ''}
                                ${result.metadata ? `<div style="color: #64748b; font-size: 11px; margin-top: 4px;">${JSON.stringify(result.metadata).substring(0, 100)}...</div>` : ''}
                            </div>
                        `;
                    });
                    html += '</div>';
                    return html;
                } else if (this.memoryQueryResults.vector_results) {
                    // Hybrid retrieval results
                    const session = this.memoryQueryResults.vector_results.session || [];
                    const longTerm = this.memoryQueryResults.vector_results.long_term || [];
                    const graphContext = this.memoryQueryResults.graph_context;
                    
                    let html = `
                        <div style="display: flex; flex-direction: column; gap: 16px;">
                            <div>
                                <div style="color: #60a5fa; font-weight: 600; margin-bottom: 8px; font-size: 13px;">Session Results (${session.length})</div>
                                <div style="display: flex; flex-direction: column; gap: 6px; max-height: 200px; overflow-y: auto;">
                    `;
                    
                    session.forEach(result => {
                        html += `
                            <div style="background: #0f172a; padding: 10px; border-radius: 4px; border-left: 3px solid #8b5cf6;">
                                <div style="color: #cbd5e1; font-size: 12px;">${this.escapeHtml(result.text?.substring(0, 150) || result.id)}...</div>
                            </div>
                        `;
                    });
                    
                    html += `
                                </div>
                            </div>
                            
                            <div>
                                <div style="color: #10b981; font-weight: 600; margin-bottom: 8px; font-size: 13px;">Long-term Results (${longTerm.length})</div>
                                <div style="display: flex; flex-direction: column; gap: 6px; max-height: 200px; overflow-y: auto;">
                    `;
                    
                    longTerm.forEach(result => {
                        html += `
                            <div style="background: #0f172a; padding: 10px; border-radius: 4px; border-left: 3px solid #10b981;">
                                <div style="color: #cbd5e1; font-size: 12px;">${this.escapeHtml(result.text?.substring(0, 150) || result.id)}...</div>
                            </div>
                        `;
                    });
                    
                    html += `
                                </div>
                            </div>
                    `;
                    
                    if (graphContext) {
                        const nodeCount = graphContext.nodes?.length || 0;
                        const relCount = graphContext.rels?.length || 0;
                        html += `
                            <div>
                                <div style="color: #f59e0b; font-weight: 600; margin-bottom: 8px; font-size: 13px;">
                                    Graph Context (${nodeCount} nodes, ${relCount} relationships)
                                </div>
                                <button 
                                    class="panel-btn" 
                                    onclick="app.visualizeSubgraph(${JSON.stringify(graphContext).replace(/"/g, '&quot;')})"
                                >
                                    üìä Visualize in Graph
                                </button>
                            </div>
                        `;
                    }
                    
                    html += '</div>';
                    return html;
                }
                
                return '<p style="color: #94a3b8;">Unknown result format</p>';
            }

            // Render entities list
            renderEntitiesList() {
                if (this.memoryEntities.length === 0) {
                    return '<p style="color: #94a3b8; font-size: 13px;">No entities extracted yet</p>';
                }
                
                let html = '<div style="display: flex; flex-direction: column; gap: 8px; max-height: 400px; overflow-y: auto;">';
                
                this.memoryEntities.forEach(entity => {
                    const confidenceColor = entity.confidence > 0.8 ? '#10b981' : 
                                        entity.confidence > 0.5 ? '#f59e0b' : '#ef4444';
                    
                    html += `
                        <div style="background: #0f172a; padding: 12px; border-radius: 6px; border-left: 3px solid ${confidenceColor};">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                <div style="color: #e2e8f0; font-weight: 600; font-size: 13px;">${this.escapeHtml(entity.text)}</div>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <span style="font-size: 11px; color: #94a3b8;">${(entity.confidence * 100).toFixed(0)}%</span>
                                    <button 
                                        class="panel-btn" 
                                        onclick="app.focusOnEntity('${entity.id}')"
                                        style="padding: 4px 8px; font-size: 11px;"
                                    >
                                        üéØ Focus
                                    </button>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                ${entity.labels?.map(label => 
                                    `<span class="label-badge" style="font-size: 10px;">${label}</span>`
                                ).join('') || ''}
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                return html;
            }

            // Render relationships list
            renderRelationshipsList() {
                if (this.memoryRelationships.length === 0) {
                    return '<p style="color: #94a3b8; font-size: 13px;">No relationships extracted yet</p>';
                }
                
                let html = '<div style="display: flex; flex-direction: column; gap: 8px; max-height: 400px; overflow-y: auto;">';
                
                this.memoryRelationships.forEach(rel => {
                    html += `
                        <div style="background: #0f172a; padding: 12px; border-radius: 6px; border-left: 3px solid #3b82f6;">
                            <div style="color: #e2e8f0; font-size: 13px; margin-bottom: 6px;">
                                <span style="color: #60a5fa;">${this.escapeHtml(rel.head)}</span>
                                <span style="color: #94a3b8; margin: 0 8px;">‚Äî[${this.escapeHtml(rel.relation)}]‚Üí</span>
                                <span style="color: #a78bfa;">${this.escapeHtml(rel.tail)}</span>
                            </div>
                            ${rel.context ? `
                                <div style="color: #64748b; font-size: 11px; margin-top: 6px; font-style: italic;">
                                    "${this.escapeHtml(rel.context.substring(0, 100))}..."
                                </div>
                            ` : ''}
                            ${rel.confidence ? `
                                <div style="color: #94a3b8; font-size: 11px; margin-top: 4px;">
                                    Confidence: ${(rel.confidence * 100).toFixed(0)}%
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                html += '</div>';
                return html;
            }

            // Helper: Perform memory query
            async performMemoryQuery() {
                const input = document.getElementById('memory-query-input');
                const typeSelect = document.getElementById('memory-retrieval-type');
                
                const query = input.value.trim();
                const retrievalType = typeSelect.value;
                
                if (!query) return;
                
                if (retrievalType === 'hybrid') {
                    await this.hybridRetrieve(query, 5, 3, 2);
                } else {
                    await this.queryMemory(query, retrievalType, 5);
                }
            }

            // Helper: Perform entity extraction
            async performEntityExtraction() {
                const input = document.getElementById('entity-extract-input');
                const autoPromote = document.getElementById('auto-promote-checkbox').checked;
                
                const text = input.value.trim();
                if (!text) return;
                
                await this.extractEntities(text, autoPromote);
                input.value = '';
                
                // Reload entities list
                await this.loadSessionEntities();
                await this.loadSessionRelationships();
            }

            // Helper: Focus on entity in graph
            async focusOnEntity(entityId) {
                // Get subgraph around this entity
                await this.getMemorySubgraph([entityId], 2);
            }
            async loadMemoryData() {
                await Promise.all([
                    this.loadSessionEntities(),
                    this.loadSessionRelationships()
                ]);
                this.updateMemoryUI();
            }
        }

        const app = new VeraChat();
    </script>
</body>
</html>